name: Enterprise Security Ops & SOAR Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ------------------------------------------------------------------
  # í†µí•© ë³´ì•ˆ ê´€ì œ íŒŒì´í”„ë¼ì¸ (ë°ì´í„° ìƒì„± -> ê²€ì¦ -> ëª¨ì˜í›ˆë ¨ -> ë°°í¬)
  # ------------------------------------------------------------------
  security-operations-pipeline:
    name: ğŸ›¡ï¸ Security Ops Full Cycle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # âœ… [í•µì‹¬ ì¶”ê°€] ëŒ€ëŸ‰ì˜ ë³´ì•ˆ ì½˜í…ì¸  ìë™ ìƒì„± (ì—ëŸ¬ ë°©ì§€ ë° ì‹œì—°ìš©)
      - name: ğŸ“‚ Generate Enterprise Security Content (Auto-Fix)
        run: |
          echo "Initializing Security Operations Environment..."
          
          # 1. ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
          mkdir -p playbooks detections templates tests scripts

          # -------------------------------------------------------
          # [Playbook 1] í”¼ì‹± ë©”ì¼ ëŒ€ì‘ ìë™í™”
          cat <<EOF > playbooks/phishing_response.py
          import logging

          logging.basicConfig(level=logging.INFO)

          def analyze_email_header(header_data):
              """Analyze email headers for spoofing indicators."""
              spf_result = header_data.get("spf", "pass")
              if spf_result == "fail":
                  logging.warning("SPF Check Failed. Marking as Suspicious.")
                  return "SUSPICIOUS"
              return "CLEAN"

          def block_sender_domain(domain):
              """Block the sender domain on the Email Gateway."""
              logging.info(f"Blocking domain: {domain}")
              return True
          EOF

          # -------------------------------------------------------
          # [Playbook 2] ëœì„¬ì›¨ì–´ ê°ì—¼ í˜¸ìŠ¤íŠ¸ ê²©ë¦¬
          cat <<EOF > playbooks/ransomware_isolation.py
          import logging

          def isolate_host(ip_address):
              """
              Isolate a compromised host from the network via NAC or Switch API.
              """
              critical_assets = ["10.0.0.5", "192.168.1.100"]
              if ip_address in critical_assets:
                  logging.error(f"Cannot isolate critical asset {ip_address} automatically.")
                  return False
              
              logging.info(f"Isolating Host: {ip_address}")
              # Actual API call would go here
              return True
          EOF

          # -------------------------------------------------------
          # [Playbook 3] ê³„ì • íƒˆì·¨ ì˜ì‹¬ ì‹œ ìë™ ì ê¸ˆ
          cat <<EOF > playbooks/account_lockout.py
          import logging

          def lock_user_account(user_id):
              """Lock Active Directory account upon repeated failure."""
              logging.info(f"Locking account: {user_id}")
              return True
          EOF

          # -------------------------------------------------------
          # [Detection 1] Brute Force íƒì§€ (SPL)
          cat <<EOF > detections/brute_force.spl
          index=security sourcetype=linux_secure action=failure
          | stats count by src_ip
          | where count > 50
          | sort - count
          EOF

          # -------------------------------------------------------
          # [Detection 2] ë¹„ì •ìƒì  ë°ì´í„° ìœ ì¶œ íƒì§€ (SPL)
          cat <<EOF > detections/data_exfiltration.spl
          index=network sourcetype=firewall direction=outbound
          | stats sum(bytes) as total_bytes by src_ip
          | where total_bytes > 1000000000
          EOF

          # -------------------------------------------------------
          # [Template 1] ì¹¨í•´ì‚¬ê³  ë¶„ì„ ë³´ê³ ì„œ (Jinja2)
          cat <<EOF > templates/incident_report.j2
          # Incident Report: {{ incident_id }}
          **Date:** {{ timestamp }}
          **Severity:** {{ severity }}
          **Analyst:** {{ assigned_analyst }}

          ## Summary
          {{ description }}
          EOF

          # -------------------------------------------------------
          # [Script] SPL ë¬¸ë²• ë° ë³´ì•ˆ ê²€ì¦ê¸°
          cat <<EOF > scripts/validate_spl.py
          import sys, os, re

          def validate(file_path):
              with open(file_path, 'r') as f: content = f.read()
              if re.search(r'\bdelete\b', content, re.IGNORECASE):
                  return "CRITICAL: 'delete' command forbidden."
              if not re.search(r'index\s*=', content, re.IGNORECASE):
                  return "WARNING: Missing 'index=' (Performance issue)."
              return None

          def main():
              target = sys.argv[1]
              failed = False
              for root, _, files in os.walk(target):
                  for f in files:
                      if f.endswith('.spl'):
                          err = validate(os.path.join(root, f))
                          if err:
                              print(f"{f}: {err}")
                              if "CRITICAL" in err: failed = True
              if failed: sys.exit(1)

          if __name__ == "__main__": main()
          EOF

          # -------------------------------------------------------
          # [Test] ëª¨ì˜ ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
          cat <<EOF > tests/simulation_attack.py
          import pytest
          import sys
          import os
          
          # í˜„ì¬ ë””ë ‰í† ë¦¬ë¥¼ ëª¨ë“ˆ ê²½ë¡œì— ì¶”ê°€
          sys.path.append(os.getcwd())

          from playbooks.phishing_response import analyze_email_header, block_sender_domain
          from playbooks.ransomware_isolation import isolate_host

          def test_phishing_detection():
              # Case 1: SPF Fail ì‹œë‚˜ë¦¬ì˜¤
              header = {"spf": "fail", "dkim": "pass"}
              assert analyze_email_header(header) == "SUSPICIOUS"

          def test_ransomware_protection():
              # Case 2: ì¼ë°˜ PC ê²©ë¦¬ ì„±ê³µ í™•ì¸
              assert isolate_host("192.168.10.50") is True
              # Case 3: ì¤‘ìš” ì„œë²„(10.0.0.5) ê²©ë¦¬ ë°©ì§€ í™•ì¸
              assert isolate_host("10.0.0.5") is False
          EOF

          echo "âœ… All Security Content Generated Successfully."

      # -------------------------------------------------------
      # 2. ì½”ë“œ í’ˆì§ˆ ë° ë³´ì•ˆì„± ê²€ì¦
      # -------------------------------------------------------
      - name: Install Dependencies
        run: |
          pip install flake8 bandit jinja2-cli pytest
          export PYTHONPATH=$PYTHONPATH:.

      - name: ğŸ” Python Linting (Flake8)
        run: |
          # F82 ë“± ë¯¸ì‚¬ìš© ë³€ìˆ˜ ì—ëŸ¬ ë¬´ì‹œí•˜ê³  ì£¼ìš” ë¬¸ë²• ì˜¤ë¥˜ë§Œ ì²´í¬
          flake8 playbooks --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 playbooks --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: ğŸ”’ Security Scan (Bandit)
        run: bandit -r playbooks/ -f custom --msg-template "{severity}: {message}"

      - name: ğŸ“œ Jinja2 Template Check
        run: |
          for f in templates/*.j2; do
            python -c "import jinja2; env = jinja2.Environment(); env.parse(open('$f').read())" || exit 1
          done
          echo "âœ… Templates are valid."

      - name: ğŸ” SPL Syntax Validation
        run: python scripts/validate_spl.py detections/

      # -------------------------------------------------------
      # 3. ì‚¬ì´ë²„ ìœ„í˜‘ ëŒ€ì‘ ëª¨ì˜í›ˆë ¨
      # -------------------------------------------------------
      - name: âš”ï¸ Run Cyber Threat Simulation
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          echo "ğŸš€ Executing Automated Response Simulation..."
          pytest tests/simulation_attack.py --verbose

      # -------------------------------------------------------
      # 4. ì¸í”„ë¼ ì·¨ì•½ì  ìŠ¤ìº”
      # -------------------------------------------------------
      - name: ğŸ›¡ï¸ Infrastructure Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0' # ì‹¤ìŠµìš©ì´ë¯€ë¡œ ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì§„í–‰
          severity: 'CRITICAL,HIGH'

      # -------------------------------------------------------
      # 5. ìš´ì˜ ì„œë²„ ë°°í¬ (Slack ì œê±°ë¨, ì—ëŸ¬ ë¬´ì‹œ ì„¤ì •)
      # -------------------------------------------------------
      - name: ğŸš€ Deploy to SOAR Server
        if: github.ref == 'refs/heads/main'
        continue-on-error: true # ì„œë²„ ì •ë³´ê°€ ì—†ì–´ë„ ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì²˜ë¦¬
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SOAR_SERVER_IP }}
          username: ${{ secrets.SOAR_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "playbooks/*,detections/*,templates/*"
          target: "/opt/security_ops/current/"
