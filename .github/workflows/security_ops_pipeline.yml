name: Auto-Upload to Repository (No Manual Token)

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  # ì‚¬ìš©ì ì •ë³´ ìë™ ì„¤ì •
  COMMIT_USER: "GitHub Action Bot"
  COMMIT_EMAIL: "action@github.com"

# [í•µì‹¬] ê¶Œí•œ ìë™ ë¶€ì—¬ ì„¤ì • (ì´ ë¶€ë¶„ì´ í† í° ìƒì„±ì„ ëŒ€ì²´í•¨)
permissions:
  contents: write

jobs:
  # ------------------------------------------------------------------
  # 1. ìì‚° ìƒì„± (ì•”í˜¸í™”, í”Œë ˆì´ë¶, ë°©í™”ë²½ ì •ì±… ë“± ëŒ€ëŸ‰ ìƒì„±)
  # ------------------------------------------------------------------
  generate-and-encrypt:
    name: ğŸ—ï¸ Generate & Prepare Assets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install cryptography

      # [1] íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì•ˆì „í•˜ê²Œ ëŒ€ëŸ‰ì˜ ë³´ì•ˆ ìì‚° ìƒì„±
      - name: ğŸ“‚ Generate Massive Security Assets
        run: |
          echo "âš™ï¸ Generating Security Assets..."
          mkdir -p playbooks detections tests scripts firewall_policies secure_storage

          # í”Œë ˆì´ë¶ ëŒ€ëŸ‰ ìƒì„±ê¸°
          cat <<EOF > scripts/asset_generator.py
          import os

          playbooks = [
              "phishing_response", "ransomware_defense", "db_audit", 
              "user_lockout", "traffic_analysis", "ddos_mitigation",
              "api_security_check", "compliance_scanner", "vpn_access_control",
              "endpoint_isolation"
          ]
          
          for pb in playbooks:
              with open(f"playbooks/{pb}.py", "w") as f:
                  f.write("import logging\n")
                  f.write("logging.basicConfig(level=logging.INFO)\n\n")
                  f.write(f"def execute_{pb}():\n")
                  f.write(f"    logging.info('ğŸ›¡ï¸ Executing Protocol: {pb}')\n")
                  f.write("    return True\n\n")
                  f.write("if __name__ == '__main__':\n")
                  f.write(f"    execute_{pb}()\n")

          # ë°©í™”ë²½ ê·œì¹™ ìƒì„±
          with open("firewall_policies/db_firewall.rules", "w") as f:
              f.write("*filter\n:INPUT DROP [0:0]\n-A INPUT -p tcp --dport 5432 -j ACCEPT\nCOMMIT")
          EOF
          
          python scripts/asset_generator.py

      # [2] AES-256 ì•”í˜¸í™” (ë³´ì•ˆ í‚¤ ìƒì„±)
      - name: ğŸ” Generate Secrets
        run: |
          cat <<EOF > scripts/encrypt_core.py
          from cryptography.fernet import Fernet
          key = Fernet.generate_key()
          with open("secure_storage/master_key.key", "wb") as f:
              f.write(key)
          EOF
          python scripts/encrypt_core.py

      # [3] ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬)
      - name: ğŸ’¾ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: |
            playbooks/
            detections/
            scripts/
            firewall_policies/
            secure_storage/

  # ------------------------------------------------------------------
  # 2. í’ˆì§ˆ ê²€ì¦ (Formatting)
  # ------------------------------------------------------------------
  qa-validation:
    name: ğŸ›¡ï¸ QA Check
    needs: generate-and-encrypt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install Black
        run: pip install black
      - name: ğŸ§¹ Auto-Format
        run: black playbooks/ scripts/

  # ------------------------------------------------------------------
  # 3. ì €ì¥ì†Œ ì—…ë¡œë“œ (ê¶Œí•œ ìë™í™” ì ìš©)
  # ------------------------------------------------------------------
  upload-to-repo:
    name: ğŸš€ Push to Repository (No Token Needed)
    needs: qa-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # ê¸°ë³¸ GITHUB_TOKEN ì‚¬ìš© (ì„¤ì •ì—ì„œ ê¶Œí•œë§Œ ì£¼ë©´ ë¨)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Generated Assets
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: generated_assets

      - name: ğŸ“‚ Move & Organize Files
        run: |
          echo "ğŸš€ Preparing files for upload..."
          
          # ê¸°ì¡´ íŒŒì¼ ë®ì–´ì“°ê¸° ë° ì´ë™
          cp -r generated_assets/* .
          
          # íŒŒì¼ ê¶Œí•œ ìˆ˜ì • (ìš”ì²­ì‚¬í•­ ë°˜ì˜)
          chmod +x scripts/*.py
          chmod +x playbooks/*.py
          chmod 600 secure_storage/*.key
          
          # ì„ì‹œ í´ë” ì‚­ì œ
          rm -rf generated_assets

      - name: ğŸ“¡ Push Changes to Repo
        run: |
          # 1. Git ì‚¬ìš©ì ì„¤ì •
          git config user.name "${{ env.COMMIT_USER }}"
          git config user.email "${{ env.COMMIT_EMAIL }}"
          
          # 2. ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
          git add playbooks/ detections/ scripts/ firewall_policies/ secure_storage/
          
          # 3. ì»¤ë°‹ ë° í‘¸ì‹œ (GITHUB_TOKEN ìë™ ì‚¬ìš©)
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes detected."
          else
            echo "ğŸ”„ Committing changes..."
            git commit -m "ğŸš€ Auto-Generated Security Assets [Automated Push]"
            
            echo "ğŸ“¡ Pushing to repository..."
            git push origin main
            echo "âœ… Successfully uploaded without manual token!"
          fi
