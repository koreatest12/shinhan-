name: Integrated Security Ops & SOAR Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'playbooks/**'
      - 'detections/**'
      - 'templates/**'
  schedule:
    - cron: '0 18 * * *' # ë§¤ì¼ í•œêµ­ ì‹œê°„ 03:00 (ì•¼ê°„ ê·¼ë¬´ ì „ ìë™ ì ê²€)

env:
  PYTHON_VERSION: '3.10'
  SOAR_SERVER: ${{ secrets.SOAR_SERVER_IP }}

jobs:
  # ------------------------------------------------------------------
  # JOB 1: ì •ì  ë¶„ì„ ë° ë¬´ê²°ì„± ê²€ì¦ (í’ˆì§ˆ ê´€ë¦¬)
  # JD ë°˜ì˜: Python/JINJA ê°œë°œ ê²½í—˜, Splunk ì¿¼ë¦¬ ê°œë°œ
  # ------------------------------------------------------------------
  static-analysis:
    name: ğŸ” Code & Logic Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Analysis Tools
        run: |
          pip install flake8 bandit jinja2-cli yamllint pytest
          # ê°€ìƒì˜ SPL ê²€ì¦ ë„êµ¬ ì„¤ì¹˜ (ì‹¤ì œë¡œëŠ” Splunk AppInspect ë“± ì‚¬ìš©)

      - name: ğŸ Python Playbook Linting
        run: |
          # í”Œë ˆì´ë¶ ì½”ë“œ ìŠ¤íƒ€ì¼ ë° ë¬¸ë²• ì˜¤ë¥˜ ê²€ì‚¬
          flake8 playbooks --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: ğŸ”’ Security Vulnerability Scan (Code)
        run: |
          # JD ë°˜ì˜: 'ì‹ ê·œ ì·¨ì•½ì  ë¶„ì„' ì—­ëŸ‰ì„ ì½”ë“œ ë ˆë²¨ì—ì„œ ì ìš©
          bandit -r playbooks/ -f custom --msg-template "{severity}: {message}"

      - name: ğŸ“œ Jinja2 Template Validation
        # JD ë°˜ì˜: 'JINJA ë“± ê°œë°œ ê²½í—˜' ìš°ëŒ€ì‚¬í•­ ë°˜ì˜
        run: |
          echo "Validating Jinja2 Templates..."
          for file in templates/*.j2; do
            python -c "import jinja2; env = jinja2.Environment(); env.parse(open('$file').read())" && echo "âœ… $file valid" || exit 1
          done

      - name: ğŸ” Splunk SPL Syntax Check
        # JD ë°˜ì˜: 'Splunk ì´í•´ ë° ì¿¼ë¦¬(SPL) ê°œë°œ'
        run: |
          # SPL íŒŒì¼ ë‚´ ê¸ˆì§€ëœ ëª…ë ¹ì–´(ì˜ˆ: delete, drop)ë‚˜ ë¹„íš¨ìœ¨ì  íŒ¨í„´ ê²€ì‚¬
          python scripts/validate_spl.py detections/

  # ------------------------------------------------------------------
  # JOB 2: ì‚¬ì´ë²„ ìœ„í˜‘ ëŒ€ì‘ ëª¨ì˜í›ˆë ¨ (ìë™í™” í…ŒìŠ¤íŠ¸)
  # JD ë°˜ì˜: 'ê¸ˆìœµ ì‚¬ì´ë²„ ìœ„í˜‘ ëŒ€ì‘ ëª¨ì˜í›ˆë ¨', 'ì¹¨í•´ì‚¬ê³  ëŒ€ì‘'
  # ------------------------------------------------------------------
  simulation-drill:
    name: âš”ï¸ Cyber Threat Mock Drill
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Test Dependencies
        run: pip install pytest mock

      - name: ğŸ§ª Execute Mock Incident Scenario
        # ê°€ìƒì˜ ê³µê²© ë¡œê·¸ë¥¼ ì£¼ì…í•˜ì—¬ í”Œë ˆì´ë¶ì´ ì˜ë„ëŒ€ë¡œ(ì°¨ë‹¨/ì•Œë¦¼) ë°˜ì‘í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
        run: |
          echo "Starting Mock Drill: Brute Force Attack Simulation..."
          pytest tests/simulation_attack.py --junitxml=test-results.xml

      - name: ğŸ“Š Upload Drill Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: drill-report
          path: test-results.xml

  # ------------------------------------------------------------------
  # JOB 3: ì¸í”„ë¼ ì·¨ì•½ì  ì ê²€ (CVE ìŠ¤ìº”)
  # JD ë°˜ì˜: 'í´ë¼ìš°ë“œ í™˜ê²½ ë³´ì•ˆê´€ì œ', 'ì‹ ê·œ ì·¨ì•½ì  ë¶„ì„'
  # ------------------------------------------------------------------
  infrastructure-scan:
    name: ğŸ›¡ï¸ Infra & Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          exit-code: '1' # ì·¨ì•½ì  ë°œê²¬ ì‹œ ë°°í¬ ì¤‘ë‹¨ (ê°•ë ¥í•œ ë³´ì•ˆ ì •ì±…)
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  # ------------------------------------------------------------------
  # JOB 4: ìš´ì˜ í™˜ê²½ ë°°í¬ (CD)
  # JD ë°˜ì˜: 'ë³´ì•ˆì¥ë¹„ ìš´ì˜', 'SOAR í”Œë ˆì´ë¶ ìš´ì˜'
  # ------------------------------------------------------------------
  deploy-to-operations:
    name: ğŸš€ Deploy to SOAR/SIEM
    needs: [simulation-drill, infrastructure-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¡ Deploy Playbooks to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SOAR_SERVER_IP }}
          username: ${{ secrets.SOAR_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "playbooks/*,templates/*"
          target: "/opt/security_ops/current/"

      - name: ğŸ”„ Reload Security Engine
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SOAR_SERVER_IP }}
          username: ${{ secrets.SOAR_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Applying new Security Policies..."
            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘ í˜¹ì€ ì„¤ì • ë¦¬ë¡œë“œ ì»¤ë§¨ë“œ
            # systemctl reload soar-engine
            echo "âœ… Deployment Complete."

      - name: ğŸ”” Shift Handover Notification
        # ì•¼ê°„/ì£¼ê°„ ê·¼ë¬´ì ê°„ ì—…ë¬´ ì¸ê³„ ì•Œë¦¼ ì‹œë®¬ë ˆì´ì…˜
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "ğŸš¨ ë³´ì•ˆê´€ì œ í”Œë ˆì´ë¶ ë° íƒì§€ ì •ì±…ì´ ìµœì‹ í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¼ë¬´ìëŠ” ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”."
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
