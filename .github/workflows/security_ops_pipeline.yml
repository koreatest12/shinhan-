name: Security Ops Complete (Release & Package & CodeQL)

on:
  schedule:
    - cron: '*/10 * * * *'  # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  COMMIT_USER: "Security Ops Bot"
  COMMIT_EMAIL: "ops@security.internal"
  # Docker ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì • (ì†Œë¬¸ì í•„ìˆ˜)
  IMAGE_NAME: "security-ops-bundle"

permissions:
  contents: write       # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ë° ë¦´ë¦¬ìŠ¤ ìƒì„± ê¶Œí•œ
  packages: write       # GitHub Packages(GHCR) ì—…ë¡œë“œ ê¶Œí•œ
  security-events: write # CodeQL ë¦¬í¬íŒ… ê¶Œí•œ
  actions: read

jobs:
  # ------------------------------------------------------------------
  # 1. MB ë‹¨ìœ„ ë³´ì•ˆ ìì‚° ìƒì„± (ë³´ì•ˆ ì½”ë”© ì ìš©)
  # ------------------------------------------------------------------
  generate-massive-assets:
    name: ğŸ—ï¸ Generate MB Assets
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.date_step.outputs.date_tag }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Generate Dynamic Version Tag
        id: date_step
        run: echo "date_tag=v$(date +'%Y.%m.%d').${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: ğŸŒ Download & Generate Massive Resources
        run: |
          mkdir -p secure_config/ssh secure_config/vpn secure_config/keys
          mkdir -p playbooks detections reports scripts logs pcap_dumps

          # Python ìŠ¤í¬ë¦½íŠ¸ë¡œ MB ë‹¨ìœ„ ë°ì´í„° ìƒì„± (CodeQL ë³´ì•ˆ íŒ¨í„´ ì ìš©)
          cat <<EOF > scripts/massive_generator.py
          import os, random, time, shlex, subprocess, logging
          
          logging.basicConfig(level=logging.INFO)
          print("ğŸš€ Generating Massive Assets...")

          # 1. 5MB ë”ë¯¸ ë¡œê·¸
          with open("logs/firewall_traffic.csv", "w") as f:
              f.write("timestamp,src,dst,action,payload\n")
              for i in range(50000):
                  f.write(f"{time.time()},192.168.1.{i%255},10.0.0.1,ALLOW,{'A'*100}\n")

          # 2. 5MB ë°”ì´ë„ˆë¦¬ ë¤í”„
          with open("pcap_dumps/capture.pcap", "wb") as f:
              f.write(os.urandom(5 * 1024 * 1024))

          # 3. CodeQL ëŒ€ì‘ ë³´ì•ˆ í”Œë ˆì´ë¶ (Command Injection ë°©ì§€ íŒ¨í„´)
          playbooks = ["ransomware_defense", "network_analysis", "user_lockout"]
          for pb in playbooks:
              with open(f"playbooks/{pb}.py", "w") as f:
                  f.write("import logging\nimport subprocess\nimport shlex\n\n")
                  f.write(f"def run_{pb}(target):\n")
                  f.write("    # [Security] Validate Input\n")
                  f.write("    if not target.isalnum(): return\n")
                  f.write("    # [Security] Safe Execution\n")
                  f.write("    cmd = shlex.split(f'echo Running {pb} on {target}')\n")
                  f.write("    subprocess.run(cmd, shell=False)\n")
          
          print("âœ… Assets Generated.")
          EOF
          
          python scripts/massive_generator.py

      - name: ğŸ’¾ Upload Artifact (ëŒ€ìš©ëŸ‰ íŒ¨í‚¤ì§€)
        uses: actions/upload-artifact@v4
        with:
          name: massive-package-artifact
          path: |
            secure_config/
            playbooks/
            detections/
            logs/
            pcap_dumps/
            scripts/

  # ------------------------------------------------------------------
  # 2. CodeQL v4 ë³´ì•ˆ ë¶„ì„ (ìœ ë¬¼ ì‚¬ì§„ ë°˜ì˜)
  # ------------------------------------------------------------------
  security-scan-codeql:
    name: ğŸ” CodeQL v4 Analysis
    needs: generate-massive-assets
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: massive-package-artifact

      - name: Initialize CodeQL (v4)
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Analyze
        uses: github/codeql-action/analyze@v4

  # ------------------------------------------------------------------
  # 3. [NEW] ë°°í¬ ë° íŒ¨í‚¤ì§€ ë“±ë¡ (ë¦´ë¦¬ìŠ¤/íŒ¨í‚¤ì§€ ì‚¬ì§„ ë°˜ì˜)
  # ------------------------------------------------------------------
  deploy-and-publish:
    name: ğŸš€ Publish Release & Package
    needs: [generate-massive-assets, security-scan-codeql]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: massive-package-artifact
          path: dist_assets

      # A. Dockerfile ìƒì„± (íŒ¨í‚¤ì§€ìš©)
      - name: ğŸ³ Create Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM python:3.11-slim
          WORKDIR /app
          COPY dist_assets/ /app/
          RUN pip install requests cryptography
          CMD ["python", "/app/scripts/playbooks/ransomware_defense.py"]
          EOF

      # B. GitHub Packages (GHCR) ë¡œê·¸ì¸ ë° í‘¸ì‹œ -> 'íŒ¨í‚¤ì§€' ì„¹ì…˜ ì±„ì›€
      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ needs.generate-massive-assets.outputs.version_tag }}

      # C. GitHub Release ìƒì„± -> 'ë¦´ë¦¬ìŠ¤' ì„¹ì…˜ ì±„ì›€
      - name: ğŸ“¦ Zip Assets for Release
        run: |
          cd dist_assets
          zip -r ../massive-security-assets.zip .
          cd ..

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.generate-massive-assets.outputs.version_tag }}
          name: "Security Ops Release ${{ needs.generate-massive-assets.outputs.version_tag }}"
          body: |
            ## ğŸš€ Automated Security Release
            - **CodeQL Status**: Passed âœ…
            - **Asset Size**: MB-Scale Verified
            - **Docker Image**: `ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}`
          files: massive-security-assets.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # D. ì €ì¥ì†Œ ì½”ë“œ ì—…ë°ì´íŠ¸ (Git Push)
      - name: ğŸ“¡ Push Changes to Repo
        run: |
          cp -r dist_assets/* .
          rm -rf dist_assets massive-security-assets.zip Dockerfile
          
          git config user.name "${{ env.COMMIT_USER }}"
          git config user.email "${{ env.COMMIT_EMAIL }}"
          git add .
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit."
          else
            git commit -m "ğŸš€ [Auto] Release ${{ needs.generate-massive-assets.outputs.version_tag }} & Package Update"
            git push origin main
          fi
