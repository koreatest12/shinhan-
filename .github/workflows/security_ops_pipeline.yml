name: Security Ops & SOAR Pipeline (No Slack)

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ------------------------------------------------------------------
  # JOB 1: ì½”ë“œ í’ˆì§ˆ ë° ë³´ì•ˆì„± ê²€ì¦ (Static Analysis)
  # ------------------------------------------------------------------
  static-analysis:
    name: ğŸ” Code & Logic Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Analysis Tools
        run: |
          pip install flake8 bandit jinja2-cli pytest

      - name: ğŸ Python Playbook Linting
        run: |
          # ë¬¸ë²• ì˜¤ë¥˜ ë° ì½”ë”© ìŠ¤íƒ€ì¼ ê²€ì‚¬
          flake8 playbooks --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 playbooks --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: ğŸ”’ Security Vulnerability Scan (Bandit)
        run: |
          # ì½”ë“œ ë‚´ ë³´ì•ˆ ì·¨ì•½ì (í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ ë“±) ìŠ¤ìº”
          bandit -r playbooks/ -f custom --msg-template "{severity}: {message}"

      - name: ğŸ“œ Jinja2 Template Validation
        run: |
          # í…œí”Œë¦¿ íŒŒì¼ ë¬¸ë²• ê²€ì¦
          for file in templates/*.j2; do
            python -c "import jinja2; env = jinja2.Environment(); env.parse(open('$file').read())" && echo "âœ… $file valid" || exit 1
          done

      - name: ğŸ” Splunk SPL Syntax Check
        run: |
          # SPL íŒŒì¼ ë‚´ ìœ„í—˜í•œ ëª…ë ¹ì–´(delete) ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python scripts/validate_spl.py detections/

  # ------------------------------------------------------------------
  # JOB 2: ì‚¬ì´ë²„ ìœ„í˜‘ ëŒ€ì‘ ëª¨ì˜í›ˆë ¨ (Simulation Drill)
  # ------------------------------------------------------------------
  simulation-drill:
    name: âš”ï¸ Cyber Threat Mock Drill
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Test Dependencies
        run: |
            pip install pytest
            # íŒŒì´ì¬ ëª¨ë“ˆ ê²½ë¡œ ì„¤ì • (í˜„ì¬ í´ë”ë¥¼ íŒ¨ìŠ¤ì— ì¶”ê°€)
            export PYTHONPATH=$PYTHONPATH:.

      - name: ğŸ§ª Execute Mock Incident Scenario
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          echo "ğŸ”¥ Starting Mock Drill: Phishing Response Simulation..."
          pytest tests/simulation_attack.py --verbose

  # ------------------------------------------------------------------
  # JOB 3: ì¸í”„ë¼ ë° ì¢…ì†ì„± ì·¨ì•½ì  ìŠ¤ìº”
  # ------------------------------------------------------------------
  infrastructure-scan:
    name: ğŸ›¡ï¸ Infra & Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          exit-code: '0' # ì·¨ì•½ì ì´ ë°œê²¬ë˜ë”ë¼ë„ ì›Œí¬í”Œë¡œìš°ë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ (ì‹¤ìŠµìš©)
          severity: 'CRITICAL,HIGH'

  # ------------------------------------------------------------------
  # JOB 4: ìš´ì˜ í™˜ê²½ ë°°í¬ (Deployment)
  # ------------------------------------------------------------------
  deploy-to-operations:
    name: ğŸš€ Deploy to SOAR Server
    needs: [simulation-drill, infrastructure-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¡ Check Secrets & Deploy
        id: deploy
        # Secretsê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì—ëŸ¬ ëŒ€ì‹  ê²½ê³  ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ë„ë¡ ì„¤ì •
        continue-on-error: true 
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SOAR_SERVER_IP }}
          username: ${{ secrets.SOAR_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "playbooks/*,templates/*,detections/*"
          target: "/opt/security_ops/current/"
      
      - name: âš ï¸ Deployment Status Check
        if: steps.deploy.outcome == 'failure'
        run: |
          echo "âš ï¸ ë°°í¬ ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "âš ï¸ GitHub Settings > Secretsì— 'SOAR_SERVER_IP', 'SSH_PRIVATE_KEY'ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
          echo "âš ï¸ (í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì´ ë©”ì‹œì§€ë¥¼ ë¬´ì‹œí•´ë„ ë©ë‹ˆë‹¤)"

      - name: ğŸ”„ Reload Security Engine (Remote Command)
        if: steps.deploy.outcome == 'success'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SOAR_SERVER_IP }}
          username: ${{ secrets.SOAR_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Applying new Security Policies..."
            # systemctl reload soar-engine
            echo "âœ… Deployment Complete."
