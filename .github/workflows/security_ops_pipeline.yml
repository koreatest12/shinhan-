name: Fixed Massive Security Ops Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  COMMIT_USER: "Security Ops Bot"
  COMMIT_EMAIL: "ops@security.internal"

# [í•µì‹¬] í† í° ì—†ì´ ì—…ë¡œë“œ ê°€ëŠ¥í•˜ë„ë¡ ê¶Œí•œ ìë™ ë¶€ì—¬
permissions:
  contents: write

jobs:
  # ------------------------------------------------------------------
  # 1. ìì‚° ìƒì„± (ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë“  í´ë”ì— íŒŒì¼ ì±„ì›Œë„£ê¸°)
  # ------------------------------------------------------------------
  generate-assets:
    name: ğŸ—ï¸ Generate Massive Assets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install cryptography

      - name: ğŸ“‚ Generate All Security Files (Python Generator)
        run: |
          echo "âš™ï¸ Initializing Generator..."
          # ëª¨ë“  íƒ€ê²Ÿ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p playbooks detections system_services tests scripts firewall_policies secure_storage reports

          # íŒŒì´ì¬ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (êµ¬ë¬¸ ì˜¤ë¥˜ ë°©ì§€ ë° íŒŒì¼ ë‚´ìš© ì±„ìš°ê¸°)
          cat <<EOF > scripts/full_generator.py
          import os

          # 1. Playbooks (Python) - 10ì¢… ìƒì„±
          playbooks = [
              "phishing_response", "ransomware_defense", "db_integrity_check", 
              "user_account_lockout", "network_traffic_analysis", "ddos_mitigation",
              "api_vulnerability_scan", "compliance_audit_log", "vpn_access_control",
              "endpoint_isolation_procedure"
          ]
          for pb in playbooks:
              with open(f"playbooks/{pb}.py", "w") as f:
                  f.write("import logging\n")
                  f.write("logging.basicConfig(level=logging.INFO)\n\n")
                  f.write(f"def execute_{pb}():\n")
                  f.write(f"    '''Auto-generated playbook for {pb}'''\n")
                  f.write(f"    logging.info('ğŸ›¡ï¸ Running Security Protocol: {pb}')\n")
                  f.write("    return 'SUCCESS'\n\n")
                  f.write("if __name__ == '__main__':\n")
                  f.write(f"    execute_{pb}()\n")

          # 2. Detections (SPL - Splunk) - ë¹ˆ í´ë” ì—ëŸ¬ ë°©ì§€ìš© íŒŒì¼ ìƒì„±
          detections = {
              "brute_force.spl": "index=auth action=failure | stats count by src_ip | where count > 100",
              "sql_injection.spl": "index=web_logs method=POST | regex uri=\"(?i)UNION SELECT\" | table src_ip uri",
              "data_exfiltration.spl": "index=firewall direction=outbound | stats sum(bytes) as total by dest_ip | where total > 10GB",
              "ransomware_ext.spl": "index=endpoint action=write | regex file_name=\".*\.(enc|lock|crypted)$\"",
              "new_admin_user.spl": "index=ad_logs EventCode=4720 | table _time, user, src_user"
          }
          for filename, content in detections.items():
              with open(f"detections/{filename}", "w") as f:
                  f.write(content)

          # 3. System Services
          with open("system_services/health_check.py", "w") as f:
              f.write("def check_status(): return 'OK'")
          
          with open("system_services/upgrade_agent.py", "w") as f:
              f.write("def upgrade(): print('Upgrading...')")

          # 4. Firewall Policies
          with open("firewall_policies/global_deny.rules", "w") as f:
              f.write("*filter\n:INPUT DROP [0:0]\n-A INPUT -p tcp --dport 443 -j ACCEPT\nCOMMIT")

          # 5. Reports (HTML)
          with open("reports/security_summary.html", "w") as f:
              f.write("<html><body><h1>Daily Security Report</h1><p>Status: Green</p></body></html>")

          print("âœ… Massive Assets Generated Successfully.")
          EOF
          
          # ìƒì„±ê¸° ì‹¤í–‰
          python scripts/full_generator.py

      - name: ğŸ” Generate Encryption Keys
        run: |
          cat <<EOF > scripts/gen_keys.py
          from cryptography.fernet import Fernet
          key = Fernet.generate_key()
          with open("secure_storage/master_access.key", "wb") as f:
              f.write(key)
          EOF
          python scripts/gen_keys.py

      - name: ğŸ’¾ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: massive-update-package
          path: |
            playbooks/
            detections/
            system_services/
            firewall_policies/
            secure_storage/
            reports/
            scripts/

  # ------------------------------------------------------------------
  # 2. QA (Formatting)
  # ------------------------------------------------------------------
  quality-control:
    name: ğŸ›¡ï¸ Code Quality Check
    needs: generate-assets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: massive-update-package
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install Black
        run: pip install black
      - name: ğŸ§¹ Auto-Format
        run: black playbooks/ scripts/ system_services/

  # ------------------------------------------------------------------
  # 3. ì €ì¥ì†Œ ì—…ë¡œë“œ (ì—ëŸ¬ ìˆ˜ì •ë¨)
  # ------------------------------------------------------------------
  upload-to-repo:
    name: ğŸš€ Push Massive Update
    needs: quality-control
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # í† í° ì—†ì´ ê¸°ë³¸ ê¶Œí•œ ì‚¬ìš©
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: massive-update-package
          path: generated_assets

      - name: ğŸ“‚ Move Files & Set Permissions
        run: |
          echo "ğŸš€ Applying Massive Updates..."
          
          # ìƒì„±ëœ ëª¨ë“  í´ë”ë¥¼ í˜„ì¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ë®ì–´ì“°ê¸°)
          cp -r generated_assets/* .
          
          # ê¶Œí•œ ëŒ€ëŸ‰ ìˆ˜ì •
          echo "ğŸ”§ Setting Execution Permissions..."
          chmod +x scripts/*.py
          chmod +x playbooks/*.py
          chmod +x system_services/*.py
          chmod 600 secure_storage/*.key
          
          # ì„ì‹œ í´ë” ì‚­ì œ
          rm -rf generated_assets
          
          # íŒŒì¼ ìƒì„± í™•ì¸ (ë””ë²„ê¹…ìš©)
          echo "ğŸ“‚ Verifying Detections Folder Content:"
          ls -F detections/

      - name: ğŸ“¡ Git Commit & Push
        run: |
          # 1. ì‚¬ìš©ì ì„¤ì •
          git config user.name "${{ env.COMMIT_USER }}"
          git config user.email "${{ env.COMMIT_EMAIL }}"
          
          # 2. íŒŒì¼ ìŠ¤í…Œì´ì§• (ì—ëŸ¬ ìˆ˜ì •ì˜ í•µì‹¬: '.' ì‚¬ìš©)
          # íŠ¹ì • í´ë”ë¥¼ ì§€ì •í•˜ì§€ ì•Šê³ , í˜„ì¬ ê²½ë¡œì˜ ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
          # ì´ë ‡ê²Œ í•˜ë©´ í´ë” ì´ë¦„ì´ ë‹¬ë¼ë„ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          git add .
          
          # 3. ì»¤ë°‹ ë° í‘¸ì‹œ
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit. Everything is up to date."
          else
            echo "ğŸ”„ Committing Massive Security Update..."
            git commit -m "ğŸš€ Massive Update: 10 Playbooks, 5 Detections, Reports & System Services"
            
            echo "ğŸ“¡ Pushing to repository..."
            git push origin main
            echo "âœ… Successfully uploaded!"
          fi
