name: Fixed External Deploy Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  TARGET_REPO: "koreatest12/shinhan-"
  COMMIT_USER: "Security Ops Bot"
  COMMIT_EMAIL: "security-bot@shinhan-ops.com"

jobs:
  # ------------------------------------------------------------------
  # 1. ìì‚° ìƒì„± (ì•”í˜¸í™”, í”Œë ˆì´ë¶, ë°©í™”ë²½ ì •ì±… ë“± ëŒ€ëŸ‰ ìƒì„±)
  # ------------------------------------------------------------------
  generate-and-encrypt:
    name: ğŸ—ï¸ Generate Assets & Encrypt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: pip install cryptography

      # [1] íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì•ˆì „í•˜ê²Œ ëŒ€ëŸ‰ì˜ ë³´ì•ˆ ìì‚° ìƒì„±
      - name: ğŸ“‚ Generate Massive Security Assets
        run: |
          echo "âš™ï¸ Initializing Asset Generators..."
          mkdir -p playbooks detections system_services tests scripts firewall_policies secure_storage

          # íŒŒì´ì¬ ìƒì„±ê¸° (êµ¬ë¬¸ ì˜¤ë¥˜ ë°©ì§€ìš©)
          cat <<EOF > scripts/asset_generator.py
          import os

          # 1. í”Œë ˆì´ë¶ 10ì¢… ìƒì„±
          playbooks = [
              "phishing_response", "ransomware_defense", "db_audit", 
              "user_lockout", "traffic_analysis", "ddos_mitigation",
              "api_security_check", "compliance_scanner", "vpn_access_control",
              "endpoint_isolation"
          ]
          
          for pb in playbooks:
              with open(f"playbooks/{pb}.py", "w") as f:
                  f.write("import logging\n")
                  f.write("logging.basicConfig(level=logging.INFO)\n\n")
                  f.write(f"def execute_{pb}():\n")
                  f.write(f"    '''Security Procedure for {pb}'''\n")
                  f.write(f"    logging.info('ğŸ›¡ï¸ Executing Protocol: {pb}')\n")
                  f.write("    return True\n\n")
                  f.write("if __name__ == '__main__':\n")
                  f.write(f"    execute_{pb}()\n")

          # 2. ë°©í™”ë²½ ì •ì±… ìƒì„± (iptables)
          rules = [
              "*filter", ":INPUT DROP [0:0]",
              "-A INPUT -p tcp --dport 22 -s 192.168.10.0/24 -j ACCEPT",
              "-A INPUT -p tcp --dport 5432 -m string --string 'UNION SELECT' -algo bm -j DROP",
              "COMMIT"
          ]
          with open("firewall_policies/db_firewall.rules", "w") as f:
              f.write('\n'.join(rules))

          print("âœ… Massive Assets Generated.")
          EOF
          
          python scripts/asset_generator.py

      # [2] AES-256 ì•”í˜¸í™” ë° ë¹„ë°€ í‚¤ ìƒì„±
      - name: ğŸ” Generate & Encrypt Secrets
        run: |
          cat <<EOF > scripts/encrypt_core.py
          from cryptography.fernet import Fernet
          import json, os

          # í‚¤ ìƒì„± ë° ì €ì¥
          key = Fernet.generate_key()
          cipher = Fernet(key)
          
          # í‚¤ëŠ” secure_storageì— ì €ì¥ (ì™¸ë¶€ ì „ì†¡ìš©)
          with open("secure_storage/master_key.key", "wb") as f:
              f.write(key)

          # ë¯¼ê° ì •ë³´ ì•”í˜¸í™”
          secret_data = json.dumps({"db_pass": "super_secret_p@ssw0rd"}).encode()
          with open("secure_storage/credentials.enc", "wb") as f:
              f.write(cipher.encrypt(secret_data))
          EOF
          python scripts/encrypt_core.py

      # [3] í…ŒìŠ¤íŠ¸ ì½”ë“œ ìƒì„±
      - name: ğŸ§ª Generate Tests
        run: |
          cat <<EOF > tests/ops_test.py
          import os
          def test_assets_exist():
              assert os.path.exists("playbooks/phishing_response.py")
          EOF

      - name: ğŸ’¾ Upload Artifacts (Temporary)
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: |
            playbooks/
            detections/
            scripts/
            firewall_policies/
            secure_storage/
            system_services/
            tests/

  # ------------------------------------------------------------------
  # 2. í’ˆì§ˆ ê²€ì¦ (Formatting & Linting)
  # ------------------------------------------------------------------
  qa-validation:
    name: ğŸ›¡ï¸ QA & Security Audit
    needs: generate-and-encrypt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Tools
        run: pip install black flake8 pytest cryptography

      - name: ğŸ§¹ Auto-Format (Black)
        run: black playbooks/ scripts/ tests/

      - name: âš”ï¸ Run Tests
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/ops_test.py

  # ------------------------------------------------------------------
  # 3. ì™¸ë¶€ ì €ì¥ì†Œ ì—…ë¡œë“œ (ì—ëŸ¬ ìˆ˜ì •ë¨)
  # ------------------------------------------------------------------
  deploy-to-external-repo:
    name: ğŸš€ Upload to Koreatest12/Shinhan-
    needs: qa-validation
    runs-on: ubuntu-latest
    steps:
      # 1. Secrets í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: ğŸ” Check Secret Availability
        run: |
          if [ -z "${{ secrets.TARGET_REPO_TOKEN }}" ]; then
            echo "âŒ CRITICAL ERROR: 'TARGET_REPO_TOKEN' secret is missing."
            echo "Please add it in Settings > Secrets and variables > Actions."
            exit 1
          else
            echo "âœ… 'TARGET_REPO_TOKEN' is found. Proceeding..."
          fi

      # 2. ìƒì„±ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download Validated Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: generated_assets

      # 3. íƒ€ê²Ÿ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ (ì¸ì¦ ë°©ì‹ ê°œì„ )
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          # ì¤‘ìš”: í† í°ì´ ëª…í™•í•˜ê²Œ ì „ë‹¬ë˜ì–´ì•¼ í•¨
          token: ${{ secrets.TARGET_REPO_TOKEN }}
          path: target_repo
          # ì¤‘ìš”: ê¸°ì¡´ ìê²© ì¦ëª… ì§€ì† ë°©ì§€ (ì¶©ëŒ ë°©ì§€)
          persist-credentials: false

      # 4. íŒŒì¼ ë³µì‚¬ ë° ê¶Œí•œ ìˆ˜ì •
      - name: ğŸ“‚ Copy Files & Modify Permissions
        run: |
          echo "ğŸš€ Copying new assets to target repository..."
          cp -r generated_assets/* target_repo/
          
          cd target_repo
          
          echo "ğŸ”§ Setting File Permissions..."
          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x scripts/*.py
          chmod +x playbooks/*.py
          # ë³´ì•ˆ í‚¤ íŒŒì¼ ì ê¸ˆ
          chmod 600 secure_storage/*.key
          
          echo "âœ… Permissions updated."

      # 5. ê°•ì œ ì¸ì¦ í‘¸ì‹œ (ì—ëŸ¬ í•´ê²°ì˜ í•µì‹¬)
      - name: ğŸ“¡ Push to External Repository
        run: |
          cd target_repo
          
          # Git ì‚¬ìš©ì ì„¤ì •
          git config user.name "${{ env.COMMIT_USER }}"
          git config user.email "${{ env.COMMIT_EMAIL }}"
          
          # ë³€ê²½ì‚¬í•­ ì¶”ê°€
          git add .
          
          # ì»¤ë°‹ ë° í‘¸ì‹œ
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit."
          else
            echo "ğŸ”„ Committing changes..."
            git commit -m "ğŸš€ Auto-Deploy: Massive Security Update & Permissions Fix"
            
            echo "ğŸ“¡ Pushing to remote..."
            # [í•µì‹¬] Remote URLì— í† í°ì„ ì§ì ‘ í¬í•¨ì‹œì¼œ ì¸ì¦ ì˜¤ë¥˜ ì›ì²œ ì°¨ë‹¨
            git remote set-url origin https://x-access-token:${{ secrets.TARGET_REPO_TOKEN }}@github.com/${{ env.TARGET_REPO }}.git
            git push origin main
            
            echo "ğŸ‰ Successfully uploaded to https://github.com/${{ env.TARGET_REPO }}"
          fi
